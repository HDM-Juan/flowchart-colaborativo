      <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proceso</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            text-align: center;
            font-size: 2rem;
            font-weight: 300;
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn.primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
        }

        .btn.danger {
            background: linear-gradient(45deg, #f44336, #da190b);
            border: none;
        }

        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .node-palette {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .palette-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: grab;
            text-align: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .palette-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .palette-item:active {
            cursor: grabbing;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .canvas {
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20px 20px, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            cursor: move;
        }

        .flowchart-node {
            position: absolute;
            min-width: 120px;
            min-height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1rem;
            cursor: move;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 500;
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .flowchart-node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .flowchart-node.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        .flowchart-node.process {
            border-radius: 8px;
        }

        .flowchart-node.decision {
            border-radius: 50%;
            min-width: 80px;
            min-height: 80px;
        }

        .flowchart-node.start-end {
            border-radius: 30px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border-color: #45a049;
        }

        /* Entity color styles */
        .flowchart-node.entity-administrativo {
            background: #8B4513;
            color: white;
            border-color: #654321;
        }

        .flowchart-node.entity-tecnico {
            background: #1E90FF;
            color: white;
            border-color: #0066CC;
        }

        .flowchart-node.entity-logistica {
            background: #FFD700;
            color: #333;
            border-color: #DAA520;
        }

        /* Decision node connection points */
        .decision-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 10;
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: #667eea;
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
        }

        .connection-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 10;
        }

        .users-online {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            min-width: 200px;
        }

        .user-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 1000;
            transition: all 0.1s ease;
        }

        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal input {
            width: 100%;
            padding: 0.75rem;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .toolbar {
                padding: 0.5rem 1rem;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1 id="processTitle">üîÑ Proceso</h1>
        <div id="processInfo" style="text-align: center; color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">
            <span id="processName">Sin t√≠tulo</span> | 
            <span id="versionInfo">Versi√≥n 1.0</span> | 
            <span id="processDate"></span> |
            <span id="userInfo">Usuario</span>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="btn primary" onclick="saveFlowchart()">üíæ Guardar Borrador</button>
        <button class="btn" onclick="loadFlowchart()">üìÇ Cargar</button>
        <button class="btn" onclick="exportFlowchart()">üì§ Exportar</button>
        <button class="btn" onclick="exportToPDF()">üìÑ Exportar PDF</button>
        <button class="btn" onclick="showLibrary()">üìö Biblioteca</button>
        <button class="btn" onclick="clearCanvas()">üóëÔ∏è Borrar Todo</button>
        <button class="btn" onclick="toggleGrid()">üìä Grid</button>
        <button class="btn danger" onclick="deleteSelected()">‚ùå Eliminar</button>
        <div style="margin-left: auto;">
            <button class="btn" onclick="zoomIn()">üîç+</button>
            <button class="btn" onclick="zoomOut()">üîç-</button>
            <button class="btn" onclick="resetZoom()">‚Ü©Ô∏è Reset</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar with Node Palette -->
        <div class="sidebar">
            <h3>üì¶ Elementos</h3>
            <div class="node-palette">
                <div class="palette-item" draggable="true" data-node-type="start-end">
                    üèÅ Inicio/Fin
                </div>
                <div class="palette-item" draggable="true" data-node-type="process">
                    ‚öôÔ∏è Proceso
                </div>
                <div class="palette-item" draggable="true" data-node-type="decision">
                    ‚ùì Decisi√≥n
                </div>
                <div class="palette-item" draggable="true" data-node-type="input-output">
                    üì• Entrada/Salida
                </div>
            </div>

            <h3 style="margin-top: 2rem;">üé® Herramientas</h3>
            <div class="node-palette">
                <div class="palette-item" onclick="toggleConnectionMode()">
                    üîó Conectar Nodos
                </div>
                <div class="palette-item" onclick="toggleTextMode()">
                    ‚úèÔ∏è Editar Texto
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="canvas-container">
            <div class="canvas" id="canvas">
                <!-- Los nodos del flowchart se agregar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Users Online Panel -->
    <div class="users-online">
        <h4>üë• Usuarios Conectados</h4>
        <div id="usersList">
            <div>üü¢ Usuario Principal</div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator" id="statusIndicator">
        üî¥ Desconectado
    </div>

    <!-- Modal for Element Editing -->
    <div class="modal" id="textModal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Editar Elemento</h3>
            
            <!-- Name input -->
            <div style="margin-bottom: 1rem;">
                <label for="nodeNameInput" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Nombre:</label>
                <input type="text" id="nodeNameInput" placeholder="Nombre del elemento">
            </div>
            
            <!-- Legacy text input (keeping for compatibility) -->
            <div style="margin-bottom: 1rem;">
                <label for="nodeTextInput" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Texto:</label>
                <input type="text" id="nodeTextInput" placeholder="Texto a mostrar">
            </div>
            
            <!-- Entity assignment -->
            <div style="margin-bottom: 1rem;">
                <label for="nodeEntitySelect" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Entidad:</label>
                <select id="nodeEntitySelect" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="">Sin asignar</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="tecnico">T√©cnico</option>
                    <option value="logistica">Log√≠stica</option>
                </select>
            </div>
            
            <!-- Description toggle -->
            <div style="margin-bottom: 1rem;">
                <button type="button" class="btn" onclick="toggleDescription()" id="descriptionToggle" style="width: 100%;">
                    üìù Mostrar Descripci√≥n
                </button>
            </div>
            
            <!-- Description field (hidden by default) -->
            <div id="descriptionField" style="display: none; margin-bottom: 1rem;">
                <label for="nodeDescriptionInput" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Descripci√≥n:</label>
                <textarea id="nodeDescriptionInput" placeholder="Descripci√≥n detallada del elemento" 
                         style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; min-height: 80px; resize: vertical;"></textarea>
            </div>
            
            <!-- Decision responses (only for decision nodes) -->
            <div id="decisionResponses" style="display: none; margin-bottom: 1rem;">
                <label for="responseCount" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">N√∫mero de Respuestas:</label>
                <input type="number" id="responseCount" min="2" max="6" value="2" 
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
            </div>
            
            <div style="margin-top: 1rem;">
                <button class="btn primary" onclick="saveNodeText()">‚úÖ Guardar</button>
                <button class="btn" onclick="closeTextModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- User Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h3>üë§ Identificaci√≥n de Usuario</h3>
            <div style="margin-bottom: 1rem;">
                <label for="userNameInput" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Nombre de Usuario:</label>
                <input type="text" id="userNameInput" placeholder="Ingresa tu nombre">
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="userRoleSelect" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Rol:</label>
                <select id="userRoleSelect" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                    <option value="user">Usuario</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn primary" onclick="loginUser()">‚úÖ Ingresar</button>
            </div>
        </div>
    </div>

    <!-- Process Info Modal -->
    <div class="modal" id="processModal">
        <div class="modal-content">
            <h3>üìã Informaci√≥n del Proceso</h3>
            <div style="margin-bottom: 1rem;">
                <label for="processNameInput" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Nombre del Proceso:</label>
                <input type="text" id="processNameInput" placeholder="Nombre del proceso">
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="processVersionInput" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Versi√≥n:</label>
                <input type="text" id="processVersionInput" placeholder="1.0" value="1.0">
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn primary" onclick="saveProcessInfo()">‚úÖ Guardar</button>
                <button class="btn" onclick="closeProcessModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Library Modal -->
    <div class="modal" id="libraryModal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3>üìö Biblioteca de Procesos</h3>
            
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                <button class="btn" onclick="showApprovedProcesses()">üìã Procesos Aprobados</button>
                <button class="btn" onclick="showMyDrafts()">üìù Mis Borradores</button>
                <button class="btn primary" onclick="createNewProcess()">‚ûï Nuevo Proceso</button>
                <button class="btn" onclick="updateProcessInfo()">‚úèÔ∏è Editar Info Proceso</button>
            </div>
            
            <div id="libraryContent">
                <!-- Content will be populated dynamically -->
            </div>
            
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn" onclick="closeLibrary()">‚ùå Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIahyAh_hQkRLQ1hN2LVA2erMW2cjjDJs",
            authDomain: "flowchart-colaborativo-hdm.firebaseapp.com",
            projectId: "flowchart-colaborativo-hdm",
            storageBucket: "flowchart-colaborativo-hdm.firebasestorage.app",
            messagingSenderId: "105428041029",
            appId: "1:105428041029:web:1d889fd5ddb41f646dd22c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Variables globales
        window.db = db;
        window.auth = auth;
        window.currentUser = null;
        window.currentUserData = {
            name: '',
            role: 'user', // 'user' or 'admin'
            uid: null
        };
        window.currentProcess = {
            name: 'Sin t√≠tulo',
            version: '1.0',
            isDraft: true,
            draftOwner: '',
            lastModified: new Date(),
            approvedBy: null,
            approvedDate: null
        };
        window.flowchartData = {
            nodes: [],
            connections: []
        };

        // Autenticaci√≥n an√≥nima
        try {
            signInAnonymously(auth).then(() => {
                document.getElementById('statusIndicator').innerHTML = 'üü¢ Conectado';
                console.log('Usuario autenticado correctamente');
            }).catch((error) => {
                console.error('Error de autenticaci√≥n:', error);
                document.getElementById('statusIndicator').innerHTML = 'üî¥ Error de conexi√≥n - Modo offline';
                // Initialize anyway in offline mode
                initializeOfflineMode();
            });
        } catch (error) {
            console.error('Firebase no disponible:', error);
            document.getElementById('statusIndicator').innerHTML = 'üî¥ Modo offline';
            initializeOfflineMode();
        }

        function initializeOfflineMode() {
            // Set a default user for offline mode
            window.currentUser = { uid: 'offline-user' };
            window.currentUserData.uid = 'offline-user';
            showLoginModal();
        }

        // Listener de autenticaci√≥n
        try {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    window.currentUserData.uid = user.uid;
                    
                    // Show login modal if user hasn't set their name
                    if (!window.currentUserData.name || window.currentUserData.name === 'Usuario') {
                        showLoginModal();
                    } else {
                        initializeFlowchart();
                    }
                }
            });
        } catch (error) {
            console.error('Firebase auth not available:', error);
            // Continue with offline mode
        }

        // Inicializar el flowchart
        function initializeFlowchart() {
            // Escuchar cambios en tiempo real
            const flowchartRef = doc(db, 'flowcharts', 'main');
            onSnapshot(flowchartRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    if (data.nodes) {
                        window.flowchartData = data;
                        renderFlowchart();
                    }
                }
            });
        }

        // Exponer funciones al scope global
        window.initializeFlowchart = initializeFlowchart;
    </script>

    <!-- Application JavaScript -->
    <script>
        // Variables globales para la aplicaci√≥n
        let selectedNode = null;
        let connectionMode = false;
        let connectionStart = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let zoomLevel = 1;
        let nodeCounter = 0;

        // Funciones globales para event handling
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.nodeType);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const nodeType = e.dataTransfer.getData('text/plain');
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoomLevel;
            const y = (e.clientY - rect.top) / zoomLevel;
            
            createNode(nodeType, x, y);
        }

        function handleMouseDown(e) {
            // Esta funci√≥n se maneja en handleNodeMouseDown para nodos espec√≠ficos
        }

        function handleMouseMove(e) {
            if (isDragging && selectedNode) {
                const canvas = document.getElementById('canvas');
                const rect = canvas.getBoundingClientRect();
                
                const newX = (e.clientX - rect.left - dragOffset.x) / zoomLevel;
                const newY = (e.clientY - rect.top - dragOffset.y) / zoomLevel;

                selectedNode.x = Math.max(0, newX);
                selectedNode.y = Math.max(0, newY);

                saveToFirebase();
                renderFlowchart();
            }
        }

        function handleMouseUp() {
            isDragging = false;
            selectedNode = null;
        }

        function handleCanvasClick(e) {
            if (e.target.id === 'canvas') {
                // Deseleccionar todos los nodos
                document.querySelectorAll('.flowchart-node').forEach(n => n.classList.remove('selected'));
                selectedNode = null;
            }
        }

        function handleNodeMouseDown(e, node) {
            e.stopPropagation();
            
            if (connectionMode) {
                if (!connectionStart) {
                    connectionStart = node;
                    document.getElementById('statusIndicator').innerHTML = 'üîó Selecciona el nodo destino';
                } else if (connectionStart.id !== node.id) {
                    createConnection(connectionStart, node);
                    connectionStart = null;
                    document.getElementById('statusIndicator').innerHTML = '‚úÖ Conexi√≥n creada';
                    setTimeout(() => {
                        document.getElementById('statusIndicator').innerHTML = 'üü¢ Conectado';
                    }, 2000);
                }
                return;
            }

            selectedNode = node;
            isDragging = true;
            
            const rect = e.target.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            // Marcar nodo como seleccionado
            document.querySelectorAll('.flowchart-node').forEach(n => n.classList.remove('selected'));
            e.target.classList.add('selected');
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            const canvas = document.getElementById('canvas');
            
            // Event listeners para drag & drop desde la paleta
            const paletteItems = document.querySelectorAll('.palette-item[draggable="true"]');
            paletteItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });

            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('drop', handleDrop);

            // Event listeners para el canvas
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleCanvasClick);
        }

        function createNode(type, x, y) {
            const node = {
                id: 'node_' + (++nodeCounter),
                type: type,
                x: x,
                y: y,
                text: getDefaultText(type),
                name: '',
                description: '',
                entity: '',
                width: 120,
                height: 60,
                responses: type === 'decision' ? 2 : 0
            };

            window.flowchartData.nodes.push(node);
            saveToFirebase();
            renderFlowchart();
        }

        function getDefaultText(type) {
            switch(type) {
                case 'start-end': return 'Inicio';
                case 'process': return 'Proceso';
                case 'decision': return '¬øDecisi√≥n?';
                case 'input-output': return 'Entrada/Salida';
                default: return 'Nodo';
            }
        }

        function renderFlowchart() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';

            // Renderizar conexiones primero (para que est√©n debajo de los nodos)
            window.flowchartData.connections?.forEach(connection => {
                renderConnection(connection);
            });

            // Renderizar nodos
            window.flowchartData.nodes?.forEach(node => {
                renderNode(node);
            });
        }

        function renderNode(node) {
            const canvas = document.getElementById('canvas');
            const nodeElement = document.createElement('div');
            
            let className = `flowchart-node ${node.type}`;
            if (node.entity) {
                className += ` entity-${node.entity}`;
            }
            
            nodeElement.className = className;
            nodeElement.id = node.id;
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            nodeElement.style.width = node.width + 'px';
            nodeElement.style.height = node.height + 'px';
            nodeElement.textContent = node.text;
            nodeElement.draggable = false;

            // Event listeners para el nodo
            nodeElement.addEventListener('mousedown', (e) => handleNodeMouseDown(e, node));
            nodeElement.addEventListener('dblclick', (e) => editNodeText(node));
            nodeElement.addEventListener('contextmenu', (e) => handleNodeRightClick(e, node));

            canvas.appendChild(nodeElement);
            
            // Add decision response points if it's a decision node
            if (node.type === 'decision' && node.responses > 0) {
                renderDecisionPoints(node, nodeElement);
            }
        }

        function renderConnection(connection) {
            const fromNode = window.flowchartData.nodes.find(n => n.id === connection.from);
            const toNode = window.flowchartData.nodes.find(n => n.id === connection.to);
            
            if (!fromNode || !toNode) return;

            const canvas = document.getElementById('canvas');
            const line = document.createElement('div');
            line.className = 'connection-line';
            line.dataset.connectionId = connection.id;

            const fromX = fromNode.x + fromNode.width / 2;
            const fromY = fromNode.y + fromNode.height / 2;
            const toX = toNode.x + toNode.width / 2;
            const toY = toNode.y + toNode.height / 2;

            const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
            const angle = Math.atan2(toY - fromY, toX - fromX) * 180 / Math.PI;

            line.style.left = fromX + 'px';
            line.style.top = fromY + 'px';
            line.style.width = length + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            // Add right-click handler for connection management
            line.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showConnectionContextMenu(e, connection);
            });

            canvas.appendChild(line);
        }

        function showConnectionContextMenu(e, connection) {
            // Remove existing context menu
            const existingMenu = document.getElementById('contextMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.id = 'contextMenu';
            menu.style.cssText = `
                position: fixed;
                top: ${e.clientY}px;
                left: ${e.clientX}px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                min-width: 150px;
            `;
            
            const deleteOption = document.createElement('div');
            deleteOption.textContent = 'üóëÔ∏è Eliminar Conexi√≥n';
            deleteOption.style.cssText = 'padding: 8px 12px; cursor: pointer; color: #f44336;';
            deleteOption.addEventListener('click', () => {
                deleteConnection(connection);
                menu.remove();
            });
            
            menu.appendChild(deleteOption);
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        function deleteConnection(connection) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta conexi√≥n?')) {
                window.flowchartData.connections = window.flowchartData.connections.filter(
                    c => c.id !== connection.id
                );
                saveToFirebase();
                renderFlowchart();
            }
        }

        function createConnection(fromNode, toNode) {
            const connection = {
                id: 'conn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                from: fromNode.id,
                to: toNode.id,
                fromResponseIndex: fromNode.responseIndex || null
            };

            if (!window.flowchartData.connections) {
                window.flowchartData.connections = [];
            }

            window.flowchartData.connections.push(connection);
            saveToFirebase();
            renderFlowchart();
        }

        function editNodeText(node) {
            const modal = document.getElementById('textModal');
            const nameInput = document.getElementById('nodeNameInput');
            const textInput = document.getElementById('nodeTextInput');
            const descriptionInput = document.getElementById('nodeDescriptionInput');
            const entitySelect = document.getElementById('nodeEntitySelect');
            const responseCountInput = document.getElementById('responseCount');
            const decisionResponses = document.getElementById('decisionResponses');
            
            // Populate fields with existing data
            nameInput.value = node.name || '';
            textInput.value = node.text || '';
            descriptionInput.value = node.description || '';
            entitySelect.value = node.entity || '';
            responseCountInput.value = node.responses || 2;
            
            // Show/hide decision-specific fields
            if (node.type === 'decision') {
                decisionResponses.style.display = 'block';
            } else {
                decisionResponses.style.display = 'none';
            }
            
            // Reset description field visibility
            document.getElementById('descriptionField').style.display = 'none';
            document.getElementById('descriptionToggle').textContent = 'üìù Mostrar Descripci√≥n';
            
            modal.style.display = 'flex';
            nameInput.focus();

            // Guardar referencia al nodo actual
            window.currentEditingNode = node;
        }

        function toggleDescription() {
            const descriptionField = document.getElementById('descriptionField');
            const toggleButton = document.getElementById('descriptionToggle');
            
            if (descriptionField.style.display === 'none') {
                descriptionField.style.display = 'block';
                toggleButton.textContent = 'üìù Ocultar Descripci√≥n';
            } else {
                descriptionField.style.display = 'none';
                toggleButton.textContent = 'üìù Mostrar Descripci√≥n';
            }
        }

        function saveNodeText() {
            const nameInput = document.getElementById('nodeNameInput');
            const textInput = document.getElementById('nodeTextInput');
            const descriptionInput = document.getElementById('nodeDescriptionInput');
            const entitySelect = document.getElementById('nodeEntitySelect');
            const responseCountInput = document.getElementById('responseCount');
            
            if (window.currentEditingNode) {
                // Update node properties
                window.currentEditingNode.name = nameInput.value.trim();
                window.currentEditingNode.text = textInput.value.trim() || getDefaultText(window.currentEditingNode.type);
                window.currentEditingNode.description = descriptionInput.value.trim();
                window.currentEditingNode.entity = entitySelect.value;
                
                if (window.currentEditingNode.type === 'decision') {
                    window.currentEditingNode.responses = parseInt(responseCountInput.value) || 2;
                }
                
                saveToFirebase();
                renderFlowchart();
                closeTextModal();
            }
        }

        function renderDecisionPoints(node, nodeElement) {
            const canvas = document.getElementById('canvas');
            const responses = node.responses || 2;
            const radius = Math.min(node.width, node.height) / 2;
            const centerX = node.x + node.width / 2;
            const centerY = node.y + node.height / 2;
            
            for (let i = 0; i < responses; i++) {
                const angle = (2 * Math.PI * i) / responses - Math.PI / 2; // Start from top
                const pointX = centerX + (radius + 15) * Math.cos(angle);
                const pointY = centerY + (radius + 15) * Math.sin(angle);
                
                const point = document.createElement('div');
                point.className = 'decision-point';
                point.style.left = (pointX - 6) + 'px';
                point.style.top = (pointY - 6) + 'px';
                point.dataset.nodeId = node.id;
                point.dataset.responseIndex = i;
                
                // Add response identifier letters
                const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
                if (i < letters.length) {
                    const label = document.createElement('div');
                    label.textContent = letters[i];
                    label.style.position = 'absolute';
                    label.style.left = '15px';
                    label.style.top = '-2px';
                    label.style.fontSize = '10px';
                    label.style.fontWeight = 'bold';
                    label.style.color = '#333';
                    point.appendChild(label);
                }
                
                // Add click handler for connections
                point.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    if (connectionMode) {
                        handleDecisionPointClick(e, node, i);
                    }
                });
                
                canvas.appendChild(point);
            }
        }

        function handleDecisionPointClick(e, node, responseIndex) {
            if (!connectionStart) {
                connectionStart = { ...node, responseIndex: responseIndex };
                document.getElementById('statusIndicator').innerHTML = 'üîó Selecciona el nodo destino';
            } else if (connectionStart.id !== node.id) {
                createConnection(connectionStart, node);
                connectionStart = null;
                document.getElementById('statusIndicator').innerHTML = '‚úÖ Conexi√≥n creada';
                setTimeout(() => {
                    document.getElementById('statusIndicator').innerHTML = 'üü¢ Conectado';
                }, 2000);
            }
        }

        function handleNodeRightClick(e, node) {
            e.preventDefault();
            showNodeContextMenu(e, node);
        }

        function showNodeContextMenu(e, node) {
            // Remove existing context menu
            const existingMenu = document.getElementById('contextMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.id = 'contextMenu';
            menu.style.cssText = `
                position: fixed;
                top: ${e.clientY}px;
                left: ${e.clientX}px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                min-width: 150px;
            `;
            
            const editOption = document.createElement('div');
            editOption.textContent = '‚úèÔ∏è Editar';
            editOption.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;';
            editOption.addEventListener('click', () => {
                editNodeText(node);
                menu.remove();
            });
            
            const deleteOption = document.createElement('div');
            deleteOption.textContent = 'üóëÔ∏è Eliminar';
            deleteOption.style.cssText = 'padding: 8px 12px; cursor: pointer; color: #f44336;';
            deleteOption.addEventListener('click', () => {
                deleteNode(node);
                menu.remove();
            });
            
            menu.appendChild(editOption);
            menu.appendChild(deleteOption);
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        function deleteNode(node) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este nodo?')) {
                // Remove node
                window.flowchartData.nodes = window.flowchartData.nodes.filter(n => n.id !== node.id);
                
                // Remove related connections
                if (window.flowchartData.connections) {
                    window.flowchartData.connections = window.flowchartData.connections.filter(
                        c => c.from !== node.id && c.to !== node.id
                    );
                }
                
                saveToFirebase();
                renderFlowchart();
            }
        }

        function closeTextModal() {
            document.getElementById('textModal').style.display = 'none';
            window.currentEditingNode = null;
        }

        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            connectionStart = null;
            
            const statusText = connectionMode ? 'üîó Modo conexi√≥n activado' : 'üü¢ Conectado';
            document.getElementById('statusIndicator').innerHTML = statusText;
            
            document.body.style.cursor = connectionMode ? 'crosshair' : 'default';
        }

        function toggleTextMode() {
            if (selectedNode) {
                editNodeText(selectedNode);
            } else {
                alert('Selecciona un nodo primero');
            }
        }

        async function saveToFirebase() {
            if (window.db && window.currentUser) {
                try {
                    const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js");
                    const flowchartRef = doc(window.db, 'flowcharts', 'main');
                    
                    await setDoc(flowchartRef, {
                        ...window.flowchartData,
                        lastUpdated: new Date(),
                        updatedBy: window.currentUser.uid
                    });
                } catch (error) {
                    console.error('Error guardando en Firebase:', error);
                    // Fallback to local storage
                    localStorage.setItem('flowchart-draft', JSON.stringify({
                        ...window.flowchartData,
                        processInfo: window.currentProcess,
                        lastModified: new Date(),
                        lastModifiedBy: window.currentUserData.name
                    }));
                }
            } else {
                // Save to local storage as fallback
                localStorage.setItem('flowchart-draft', JSON.stringify({
                    ...window.flowchartData,
                    processInfo: window.currentProcess,
                    lastModified: new Date(),
                    lastModifiedBy: window.currentUserData.name
                }));
            }
        }

        // Funciones de la toolbar
        function saveFlowchart() {
            const dataStr = JSON.stringify(window.flowchartData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'flowchart.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function loadFlowchart() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            window.flowchartData = JSON.parse(e.target.result);
                            saveToFirebase();
                            renderFlowchart();
                        } catch (error) {
                            alert('Error al cargar el archivo');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportFlowchart() {
            // Implementar exportaci√≥n a imagen SVG o PNG
            alert('Funci√≥n de exportaci√≥n en desarrollo');
        }

        function clearCanvas() {
            if (confirm('¬øEst√°s seguro de que quieres borrar todo el canvas y empezar de nuevo?')) {
                window.flowchartData = { nodes: [], connections: [] };
                window.currentProcess.lastModified = new Date();
                saveToFirebase();
                renderFlowchart();
            }
        }

        function deleteSelected() {
            if (selectedNode) {
                // Eliminar el nodo
                window.flowchartData.nodes = window.flowchartData.nodes.filter(n => n.id !== selectedNode.id);
                
                // Eliminar conexiones relacionadas
                if (window.flowchartData.connections) {
                    window.flowchartData.connections = window.flowchartData.connections.filter(
                        c => c.from !== selectedNode.id && c.to !== selectedNode.id
                    );
                }
                
                selectedNode = null;
                saveToFirebase();
                renderFlowchart();
            }
        }

        function toggleGrid() {
            const canvas = document.getElementById('canvas');
            const hasGrid = canvas.style.backgroundImage.includes('radial-gradient');
            
            if (hasGrid) {
                canvas.style.backgroundImage = 'none';
            } else {
                canvas.style.backgroundImage = 'radial-gradient(circle at 20px 20px, rgba(255,255,255,0.1) 1px, transparent 1px)';
                canvas.style.backgroundSize = '20px 20px';
            }
        }

        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 3);
            applyZoom();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.3);
            applyZoom();
        }

        function resetZoom() {
            zoomLevel = 1;
            applyZoom();
        }

        function applyZoom() {
            const canvas = document.getElementById('canvas');
            canvas.style.transform = `scale(${zoomLevel})`;
            canvas.style.transformOrigin = '0 0';
        }

        // Event listeners para cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTextModal();
                closeLibrary();
                closeProcessModal();
            }
        });

        // Prevenir selecci√≥n de texto durante el arrastre
        document.addEventListener('selectstart', function(e) {
            if (isDragging) {
                e.preventDefault();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure currentUserData is properly initialized
            if (!window.currentUserData) {
                window.currentUserData = {
                    name: 'Usuario',
                    role: 'user',
                    uid: null
                };
            }
            
            // Ensure currentProcess is properly initialized
            if (!window.currentProcess) {
                window.currentProcess = {
                    name: 'Sin t√≠tulo',
                    version: '1.0',
                    isDraft: true,
                    draftOwner: '',
                    lastModified: new Date(),
                    approvedBy: null,
                    approvedDate: null
                };
            }
            
            updateProcessDisplay();
            updateDateDisplay();
            updateUserDisplay();
        });

        // === NEW FUNCTIONALITY ===

        // User Management
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function loginUser() {
            const userName = document.getElementById('userNameInput').value.trim();
            const userRole = document.getElementById('userRoleSelect').value;
            
            if (!userName) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            
            window.currentUserData.name = userName;
            window.currentUserData.role = userRole;
            
            document.getElementById('loginModal').style.display = 'none';
            updateUserDisplay();
            initializeFlowchart();
        }

        function updateUserDisplay() {
            const userInfo = document.getElementById('userInfo');
            if (window.currentUserData && window.currentUserData.name) {
                const roleIcon = window.currentUserData.role === 'admin' ? 'üëë' : 'üë§';
                userInfo.textContent = `${roleIcon} ${window.currentUserData.name}`;
            } else {
                userInfo.textContent = 'üë§ Usuario';
            }
        }

        // Process Management
        function updateProcessDisplay() {
            const processName = document.getElementById('processName');
            const versionInfo = document.getElementById('versionInfo');
            
            let displayName = window.currentProcess.name;
            if (window.currentProcess.isDraft && window.currentUserData && window.currentUserData.name) {
                displayName += ` (Borrador - ${window.currentUserData.name})`;
            }
            
            processName.textContent = displayName;
            versionInfo.textContent = `Versi√≥n ${window.currentProcess.version}`;
        }

        function updateDateDisplay() {
            const processDate = document.getElementById('processDate');
            const now = new Date();
            processDate.textContent = now.toLocaleDateString('es-ES');
        }

        function updateProcessInfo() {
            const modal = document.getElementById('processModal');
            const nameInput = document.getElementById('processNameInput');
            const versionInput = document.getElementById('processVersionInput');
            
            nameInput.value = window.currentProcess.name;
            versionInput.value = window.currentProcess.version;
            
            modal.style.display = 'flex';
        }

        function saveProcessInfo() {
            const nameInput = document.getElementById('processNameInput');
            const versionInput = document.getElementById('processVersionInput');
            
            window.currentProcess.name = nameInput.value.trim() || 'Sin t√≠tulo';
            window.currentProcess.version = versionInput.value.trim() || '1.0';
            window.currentProcess.lastModified = new Date();
            
            updateProcessDisplay();
            closeProcessModal();
            saveToFirebase();
        }

        function closeProcessModal() {
            document.getElementById('processModal').style.display = 'none';
        }

        // Library Management
        function showLibrary() {
            document.getElementById('libraryModal').style.display = 'flex';
            showMyDrafts(); // Default view
        }

        function closeLibrary() {
            document.getElementById('libraryModal').style.display = 'none';
        }

        async function showApprovedProcesses() {
            const content = document.getElementById('libraryContent');
            content.innerHTML = '<div style="text-align: center; padding: 2rem;">üìã Cargando procesos aprobados...</div>';
            
            try {
                const approvedProcesses = await loadFromGoogleSheets();
                
                if (approvedProcesses.length === 0) {
                    content.innerHTML = `
                        <h4>üìã Procesos Aprobados</h4>
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            No hay procesos aprobados a√∫n.
                            <br><br>
                            Los administradores pueden aprobar borradores para que aparezcan aqu√≠.
                        </div>
                    `;
                } else {
                    let html = '<h4>üìã Procesos Aprobados (Biblioteca)</h4><div style="margin-top: 1rem;">';
                    
                    approvedProcesses.forEach(process => {
                        html += `
                            <div style="border: 1px solid #4CAF50; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: #f8fff8;">
                                <h5>‚úÖ ${process.name}</h5>
                                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">
                                    Versi√≥n ${process.version} | Aprobado por: ${process.approvedBy} | 
                                    Fecha: ${new Date(process.approvedDate).toLocaleDateString('es-ES')}
                                    <br>Autor original: ${process.originalAuthor}
                                </p>
                                <div style="margin-top: 1rem;">
                                    <button class="btn primary" onclick="loadApprovedProcess('${process.id}')" style="margin-right: 0.5rem;">üìÇ Usar como Base</button>
                                    <button class="btn" onclick="viewProcessDetails('${process.id}')">üëÅÔ∏è Ver Detalles</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    content.innerHTML = html;
                }
            } catch (error) {
                content.innerHTML = '<div style="color: red; text-align: center;">Error al cargar procesos aprobados desde Google Sheets</div>';
            }
        }

        async function showMyDrafts() {
            const content = document.getElementById('libraryContent');
            content.innerHTML = '<div style="text-align: center; padding: 2rem;">üìù Cargando mis borradores...</div>';
            
            try {
                // This would fetch user drafts from Firebase
                const drafts = await getUserDrafts();
                
                if (drafts.length === 0) {
                    content.innerHTML = `
                        <h4>üìù Mis Borradores</h4>
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            No tienes borradores guardados.
                            <br><br>
                            Crea un nuevo proceso o modifica uno existente para crear un borrador.
                        </div>
                    `;
                } else {
                    let html = '<h4>üìù Mis Borradores</h4><div style="margin-top: 1rem;">';
                    
                    drafts.forEach(draft => {
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9;">
                                <h5>${draft.name}</h5>
                                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">
                                    Versi√≥n ${draft.version} | Modificado: ${new Date(draft.lastModified).toLocaleString('es-ES')}
                                </p>
                                <div style="margin-top: 1rem;">
                                    <button class="btn" onclick="loadDraft('${draft.id}')" style="margin-right: 0.5rem;">üìÇ Cargar</button>
                                    <button class="btn danger" onclick="deleteDraft('${draft.id}')" style="margin-right: 0.5rem;">üóëÔ∏è Eliminar</button>
                                    ${window.currentUserData.role === 'admin' ? 
                                        `<button class="btn primary" onclick="approveDraft('${draft.id}')">‚úÖ Aprobar</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    content.innerHTML = html;
                }
            } catch (error) {
                content.innerHTML = '<div style="color: red; text-align: center;">Error al cargar borradores</div>';
            }
        }

        async function getUserDrafts() {
            // Placeholder - would fetch from Firebase in real implementation
            return [
                {
                    id: 'draft1',
                    name: 'Proceso de Ejemplo',
                    version: '1.0',
                    lastModified: new Date(),
                    owner: window.currentUserData.name
                }
            ];
        }

        function createNewProcess() {
            if (confirm('¬øCrear un nuevo proceso? Se perder√°n los cambios no guardados.')) {
                window.flowchartData = { nodes: [], connections: [] };
                window.currentProcess = {
                    name: 'Nuevo Proceso',
                    version: '1.0',
                    isDraft: true,
                    draftOwner: window.currentUserData.name,
                    lastModified: new Date()
                };
                
                updateProcessDisplay();
                renderFlowchart();
                closeLibrary();
                updateProcessInfo(); // Show the process info modal
            }
        }

        async function loadDraft(draftId) {
            // Placeholder - would load from Firebase
            alert('Funcionalidad de cargar borrador en desarrollo');
            closeLibrary();
        }

        async function deleteDraft(draftId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este borrador?')) {
                // Placeholder - would delete from Firebase
                alert('Borrador eliminado');
                showMyDrafts(); // Refresh the list
            }
        }

        async function approveDraft(draftId) {
            if (window.currentUserData.role !== 'admin') {
                alert('Solo los administradores pueden aprobar procesos');
                return;
            }
            
            if (confirm('¬øAprobar este proceso? Se agregar√° a la biblioteca de procesos aprobados y se guardar√° en Google Sheets.')) {
                try {
                    // Get current flowchart data
                    const approvalData = {
                        ...window.flowchartData,
                        processInfo: {
                            ...window.currentProcess,
                            isDraft: false,
                            approvedBy: window.currentUserData.name,
                            approvedDate: new Date()
                        }
                    };
                    
                    // Save to Google Sheets
                    await saveToGoogleSheets(approvalData);
                    
                    alert('Proceso aprobado y guardado en la biblioteca de Google Sheets');
                    showMyDrafts(); // Refresh the list
                } catch (error) {
                    alert('Error al aprobar el proceso: ' + error.message);
                }
            }
        }

        async function loadApprovedProcess(processId) {
            if (confirm('¬øCargar este proceso aprobado como base para un nuevo borrador? Se perder√°n los cambios no guardados.')) {
                try {
                    // In a real implementation, this would load the process data from Google Sheets
                    alert('Cargando proceso aprobado como nuevo borrador...');
                    
                    // Create a new draft based on the approved process
                    window.currentProcess = {
                        name: 'Copia de Proceso Aprobado',
                        version: '1.0',
                        isDraft: true,
                        draftOwner: window.currentUserData.name,
                        lastModified: new Date(),
                        basedOn: processId
                    };
                    
                    updateProcessDisplay();
                    closeLibrary();
                } catch (error) {
                    alert('Error al cargar el proceso: ' + error.message);
                }
            }
        }

        function viewProcessDetails(processId) {
            alert('Mostrando detalles del proceso aprobado. En una implementaci√≥n completa, esto abrir√≠a una vista detallada del proceso.');
        }

        // PDF Export (simplified version without external dependencies)
        async function exportToPDF() {
            try {
                // For now, show a print dialog which can save as PDF
                const originalTitle = document.title;
                document.title = `${window.currentProcess.name}_v${window.currentProcess.version}`;
                
                // Create a print-friendly version
                const printContent = createPrintContent();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                
                document.title = originalTitle;
                
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Error al exportar PDF. Usa Ctrl+P para imprimir o guardar como PDF.');
            }
        }

        function createPrintContent() {
            const canvas = document.getElementById('canvas');
            const canvasHTML = canvas.innerHTML;
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${window.currentProcess.name} - Versi√≥n ${window.currentProcess.version}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .flowchart-node { 
                            position: absolute; 
                            min-width: 120px; 
                            min-height: 60px; 
                            background: white; 
                            border: 2px solid #333; 
                            border-radius: 8px; 
                            padding: 1rem; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            text-align: center; 
                            font-weight: 500; 
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .flowchart-node.start-end { border-radius: 30px; background: #4CAF50; color: white; }
                        .flowchart-node.decision { border-radius: 50%; min-width: 80px; min-height: 80px; }
                        .flowchart-node.entity-administrativo { background: #8B4513; color: white; }
                        .flowchart-node.entity-tecnico { background: #1E90FF; color: white; }
                        .flowchart-node.entity-logistica { background: #FFD700; color: #333; }
                        .canvas { position: relative; height: 600px; border: 1px solid #ccc; }
                        .connection-line { position: absolute; height: 2px; background: #333; }
                        @media print { 
                            body { margin: 0; } 
                            .canvas { height: auto; min-height: 400px; page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${window.currentProcess.name}</h1>
                        <p>Versi√≥n ${window.currentProcess.version} | ${new Date().toLocaleDateString('es-ES')}</p>
                        <p>Usuario: ${window.currentUserData ? window.currentUserData.name : 'Usuario'}</p>
                        ${window.currentProcess.isDraft ? '<p><strong>Estado: Borrador</strong></p>' : ''}
                    </div>
                    <div class="canvas">
                        ${canvasHTML}
                    </div>
                </body>
                </html>
            `;
        }

        // Enhanced save function
        async function saveFlowchart() {
            if (!window.currentUserData.name || window.currentUserData.name === 'Usuario') {
                alert('Primero debes identificarte como usuario');
                showLoginModal();
                return;
            }
            
            // Update process metadata
            window.currentProcess.lastModified = new Date();
            window.currentProcess.draftOwner = window.currentUserData.name;
            
            // Combine flowchart data with process metadata
            const saveData = {
                ...window.flowchartData,
                processInfo: window.currentProcess,
                lastModifiedBy: window.currentUserData.name,
                lastModified: new Date()
            };
            
            // Save to Firebase (draft)
            await saveToFirebase();
            
            // Also save as downloadable file
            const dataStr = JSON.stringify(saveData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${window.currentProcess.name.replace(/[^a-z0-9]/gi, '_')}_borrador.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Borrador guardado correctamente');
        }

        // Google Sheets Integration (placeholder implementation)
        async function saveToGoogleSheets(processData) {
            // This would integrate with Google Sheets API
            // For now, it's a placeholder showing what would be saved
            const sheetData = {
                processName: processData.processInfo.name,
                version: processData.processInfo.version,
                approvedBy: window.currentUserData.name,
                approvedDate: new Date().toISOString(),
                originalAuthor: processData.processInfo.draftOwner,
                lastModified: processData.processInfo.lastModified,
                nodeCount: processData.nodes ? processData.nodes.length : 0,
                connectionCount: processData.connections ? processData.connections.length : 0,
                flowchartData: JSON.stringify(processData)
            };
            
            console.log('Would save to Google Sheets:', sheetData);
            
            // In a real implementation, this would use the Google Sheets API:
            // await gapi.client.sheets.spreadsheets.values.append({
            //     spreadsheetId: 'YOUR_SPREADSHEET_ID',
            //     range: 'ProcessLibrary!A:H',
            //     valueInputOption: 'RAW',
            //     resource: {
            //         values: [[
            //             sheetData.processName,
            //             sheetData.version,
            //             sheetData.approvedBy,
            //             sheetData.approvedDate,
            //             sheetData.originalAuthor,
            //             sheetData.lastModified,
            //             sheetData.nodeCount,
            //             sheetData.flowchartData
            //         ]]
            //     }
            // });
            
            return true;
        }

        async function loadFromGoogleSheets() {
            // This would load approved processes from Google Sheets
            // For now, return placeholder data
            return [
                {
                    id: 'approved1',
                    name: 'Proceso de Ventas Aprobado',
                    version: '2.0',
                    approvedBy: 'Admin',
                    approvedDate: new Date('2024-01-15'),
                    originalAuthor: 'Juan'
                },
                {
                    id: 'approved2', 
                    name: 'Proceso de Compras Aprobado',
                    version: '1.5',
                    approvedBy: 'Admin',
                    approvedDate: new Date('2024-02-01'),
                    originalAuthor: 'Maria'
                }
            ];
        }
    </script>
</body>
</html>
