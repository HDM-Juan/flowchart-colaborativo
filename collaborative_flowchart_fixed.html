        function clearCanvas() {
            <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramas de Flujo Colaborativos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-role {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            background: #e74c3c;
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            height: calc(100vh - 80px);
            gap: 0;
        }

        .left-sidebar {
            background: white;
            border-right: 1px solid #e0e6ed;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e6ed;
        }

        .tab {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .shapes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .shape-item {
            padding: 0.75rem;
            border: 2px solid #3498db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-size: 0.8rem;
            user-select: none;
        }

        .shape-item:hover {
            background: #3498db;
            color: white;
            transform: scale(1.05);
        }

        .shape-item:active {
            transform: scale(0.95);
        }

        .shape-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 0.5rem;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            position: relative;
            background: currentColor;
            color: white;
        }

        .shape-icon.start-end {
            border-radius: 50%;
        }

        .shape-icon.process {
            border-radius: 4px;
        }

        .shape-icon.decision {
            transform: rotate(45deg);
            border-radius: 4px;
        }

        .shape-icon.decision span {
            transform: rotate(-45deg);
        }

        .shape-icon.document {
            border-radius: 4px 4px 0 0;
            position: relative;
        }

        .shape-icon.document::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: -2px;
            right: -2px;
            height: 8px;
            background: currentColor;
            border-radius: 0 0 8px 8px;
        }

        .shape-icon.data {
            border-radius: 0 8px 0 8px;
        }

        .shape-icon.connect {
            border-radius: 4px;
            border: none;
            background: linear-gradient(90deg, currentColor 0%, currentColor 40%, transparent 40%, transparent 60%, currentColor 60%, currentColor 100%);
            position: relative;
        }

        .shape-icon.connect::after {
            content: '‚ñ∂';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
        }

        .instructions {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #e3f2fd;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-size: 0.8rem;
        }

        .instructions-title {
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 0.5rem;
        }

        .instructions-text {
            color: #1976d2;
            line-height: 1.4;
        }

        .resize-handle {
            background: #3498db;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: n-resize;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            border-top: 2px solid #2980b9;
            border-bottom: 2px solid #2980b9;
            user-select: none;
        }

        .resize-handle:hover {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .moderator-panel {
            background: #f8f9fa;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            border-top: 1px solid #e0e6ed;
        }

        .moderator-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #e74c3c;
            font-size: 0.9rem;
        }

        .moderator-btn {
            width: 100%;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .moderator-btn:hover {
            background: #2980b9;
        }

        .content-area {
            background: white;
            display: flex;
            flex-direction: column;
        }

        .process-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e0e6ed;
        }

        .process-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .process-version {
            color: #f39c12;
            font-weight: 600;
        }

        .canvas-controls {
            padding: 1rem 2rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e6ed;
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .canvas {
            flex: 1;
            background: white;
            position: relative;
            overflow: auto;
            border: 2px dashed #ddd;
            margin: 1rem;
            border-radius: 8px;
        }

        .canvas-content {
            position: relative;
            transform-origin: top left;
            transition: transform 0.3s ease;
            min-width: 100%;
            min-height: 100%;
        }

        .canvas-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .flowchart-element {
            position: absolute;
            min-width: 120px;
            min-height: 70px;
            border: 3px solid #27ae60;
            border-radius: 50px;
            background: #e8f5e8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            font-weight: 600;
            text-align: center;
            padding: 0.75rem;
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
            user-select: none;
            font-size: 0.9rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .flowchart-element:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .flowchart-element:active {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .flowchart-element.process {
            border-radius: 8px;
            background: #e3f2fd;
            border-color: #3498db;
        }

        .flowchart-element.decision {
            min-width: 80px;
            min-height: 80px;
            border-radius: 8px;
            background: #fff3cd;
            border-color: #f39c12;
            transform: rotate(45deg);
            padding: 0.5rem;
            font-size: 0.7rem;
            position: relative;
        }

        .flowchart-element.decision span {
            transform: rotate(-45deg);
            display: block;
            text-align: center;
            line-height: 1.1;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .decision-connection-point {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #f39c12;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .decision-connection-point:hover {
            background: #e67e22;
            transform: scale(1.3);
            z-index: 25;
        }

        .decision-connection-point.top {
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .decision-connection-point.right {
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .decision-connection-point.bottom {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .decision-connection-point.left {
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .decision-connection-point.top:hover {
            transform: translateX(-50%) scale(1.3);
        }

        .decision-connection-point.right:hover {
            transform: translateY(-50%) scale(1.3);
        }

        .decision-connection-point.bottom:hover {
            transform: translateX(-50%) scale(1.3);
        }

        .decision-connection-point.left:hover {
            transform: translateY(-50%) scale(1.3);
        }

        /* Etiquetas de conexi√≥n */
        .connection-label {
            position: absolute;
            background: rgba(243, 156, 18, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            z-index: 30;
            white-space: nowrap;
            pointer-events: none;
        }

        /* POST-ITS */
        .post-it {
            position: absolute;
            width: 150px;
            min-height: 100px;
            background: #ffeb3b;
            border: 1px solid #fbc02d;
            border-radius: 0 0 5px 5px;
            padding: 0.5rem;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: move;
            z-index: 50;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            transform: rotate(-2deg);
        }

        .post-it::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            height: 20px;
            background: #f9a825;
            border-radius: 2px 2px 0 0;
        }

        .post-it-content {
            margin-top: 15px;
            outline: none;
            border: none;
            background: transparent;
            width: 100%;
            min-height: 60px;
            resize: none;
            font-family: inherit;
            font-size: inherit;
        }

        .post-it-controls {
            position: absolute;
            top: 2px;
            right: 5px;
            display: flex;
            gap: 3px;
        }

        .post-it-btn {
            width: 15px;
            height: 15px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .post-it-delete {
            background: #f44336;
            color: white;
        }

        .post-it.blue {
            background: #2196f3;
            border-color: #1976d2;
        }

        .post-it.blue::before {
            background: #1976d2;
        }

        .post-it.green {
            background: #4caf50;
            border-color: #388e3c;
        }

        .post-it.green::before {
            background: #388e3c;
        }

        .post-it.pink {
            background: #e91e63;
            border-color: #c2185b;
        }

        .post-it.pink::before {
            background: #c2185b;
        }

        .flowchart-element.document {
            border-radius: 8px 8px 0 0;
            background: #f8f9fa;
            border-color: #6c757d;
        }

        .flowchart-element.data {
            border-radius: 0 15px 0 15px;
            background: #fde2e4;
            border-color: #e74c3c;
        }

        .connection-line {
            position: absolute;
            background: #3498db;
            height: 3px;
            transform-origin: left center;
            z-index: 10;
            pointer-events: none;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid #3498db;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 11;
            pointer-events: none;
        }

        .connection-mode .flowchart-element {
            border-width: 4px !important;
        }

        .connection-mode .flowchart-element:hover {
            border-color: #e74c3c !important;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.5) !important;
        }

        .connection-mode .flowchart-element.selected-for-connection {
            border-color: #27ae60 !important;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.7) !important;
        }

        .connection-mode-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            z-index: 2000;
            display: none;
        }

        .connection-mode-indicator.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .color-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .color-option {
            padding: 0.75rem;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .color-option.selected {
            border-color: #3498db;
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e6ed;
        }

        .btn-modal {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary-modal {
            background: #3498db;
            color: white;
        }

        .btn-primary-modal:hover {
            background: #2980b9;
        }

        .btn-secondary-modal {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary-modal:hover {
            background: #7f8c8d;
        }

        .right-sidebar {
            background: white;
            border-left: 2px solid #3498db;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #3498db;
            color: white;
            padding: 1rem;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #3498db;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-author {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message-time {
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-top: 0.25rem;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid #e0e6ed;
            display: flex;
            gap: 0.5rem;
            background: white;
        }

        .chat-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .concept-item {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }

        .concept-item:hover {
            border-color: #3498db;
        }

        .concept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .concept-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .concept-status.pending { background: #fff3cd; color: #856404; }
        .concept-status.official { background: #d1e7dd; color: #0f5132; }
        .concept-status.voting { background: #cff4fc; color: #055160; }

        .participants-list {
            list-style: none;
        }

        .participant {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üìä Diagramas de Flujo Colaborativos</div>
        <div class="user-info">
            <span id="userName">Juan P√©rez</span>
            <span id="userRole" class="user-role">Moderador</span>
        </div>
    </div>

    <div class="main-container">
        <div class="left-sidebar">
            <div class="tabs">
                <button class="tab active" onclick="showTab('shapes')">üìù Formas</button>
                <button class="tab" onclick="showTab('concepts')">üìö Conceptos</button>
                <button class="tab" onclick="showTab('participants')">üë• Usuarios</button>
            </div>
            
            <div class="tab-content">
                <div id="shapes-tab" class="tab-panel active">
                    <div class="shapes-grid">
                        <div class="shape-item" onclick="openConfigModal('start-end')">
                            <div class="shape-icon start-end"><span>‚óè</span></div>
                            <div>Inicio/Fin</div>
                        </div>
                        <div class="shape-item" onclick="openConfigModal('process')">
                            <div class="shape-icon process"><span>‚ñ°</span></div>
                            <div>Proceso</div>
                        </div>
                        <div class="shape-item" onclick="openConfigModal('decision')">
                            <div class="shape-icon decision"><span>?</span></div>
                            <div>Decisi√≥n</div>
                        </div>
                        <div class="shape-item" onclick="openConfigModal('document')">
                            <div class="shape-icon document"><span>üìÑ</span></div>
                            <div>Documento</div>
                        </div>
                        <div class="shape-item" onclick="toggleConnectionMode()">
                            <div class="shape-icon connect"><span>‚Üí</span></div>
                            <div>Conectar</div>
                        </div>
                        <div class="shape-item" onclick="createPostIt()">
                            <div class="shape-icon" style="background: #ffeb3b; color: #333;"><span>üìù</span></div>
                            <div>Post-it</div>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        <div class="instructions-title">üì¶ Instrucciones:</div>
                        <div class="instructions-text">
                            1. Haz clic en cualquier elemento de arriba<br>
                            2. Se abrir√° ventana de configuraci√≥n<br>
                            3. Configura t√≠tulo, responsable y descripci√≥n<br>
                            4. El elemento aparecer√° en el canvas<br>
                            5. Usa "Conectar" para unir elementos
                        </div>
                    </div>
                </div>
                
                <div id="concepts-tab" class="tab-panel">
                    <h3 style="margin-bottom: 1rem; font-size: 1rem;">üìö Gesti√≥n de Conceptos</h3>
                    
                    <div class="concept-item" onclick="openConceptModal('servicio')">
                        <div class="concept-header">
                            <span>üîß Servicio</span>
                            <span class="concept-status pending">Pendiente</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">3 definiciones ‚Ä¢ 0 votos</div>
                    </div>
                    
                    <div class="concept-item" onclick="openConceptModal('diagnostico')">
                        <div class="concept-header">
                            <span>üîç Diagn√≥stico</span>
                            <span class="concept-status official">Oficial</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">2 definiciones ‚Ä¢ Votado</div>
                    </div>
                    
                    <div class="concept-item" onclick="openConceptModal('calidad')">
                        <div class="concept-header">
                            <span>‚≠ê Calidad</span>
                            <span class="concept-status voting">En Votaci√≥n</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">4 definiciones ‚Ä¢ 12 votos</div>
                    </div>
                </div>
                
                <div id="participants-tab" class="tab-panel">
                    <h3 style="margin-bottom: 1rem; font-size: 1rem;">üë• Participantes</h3>
                    <ul class="participants-list">
                        <li class="participant" style="border-left-color: #e74c3c;">
                            <div>
                                <div style="font-weight: 500;">Juan P√©rez</div>
                                <div style="font-size: 0.75rem; color: #7f8c8d;">Moderador</div>
                            </div>
                            <div style="color: #e74c3c;">‚óè</div>
                        </li>
                        <li class="participant" style="border-left-color: #3498db;">
                            <div>
                                <div style="font-weight: 500;">Mar√≠a Garc√≠a</div>
                                <div style="font-size: 0.75rem; color: #7f8c8d;">Participante</div>
                            </div>
                            <div style="color: #3498db;">‚óè</div>
                        </li>
                        <li class="participant" style="border-left-color: #27ae60;">
                            <div>
                                <div style="font-weight: 500;">Carlos L√≥pez</div>
                                <div style="font-size: 0.75rem; color: #7f8c8d;">Participante</div>
                            </div>
                            <div style="color: #27ae60;">‚óè</div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="resize-handle" id="resizeHandle">
                ‚¨ÜÔ∏è ARRASTRA PARA REDIMENSIONAR ‚¨ÜÔ∏è
            </div>
            
            <div class="moderator-panel" id="moderatorPanel">
                <div class="moderator-title">üîß Panel de Moderador</div>
                <button class="moderator-btn" onclick="saveData()">üé® Gestionar Colores</button>
                <button class="moderator-btn" onclick="showMessage('Funci√≥n de preguntas')">‚ùì Agregar Pregunta</button>
                <button class="moderator-btn" onclick="showMessage('Funci√≥n de unir procesos')">üîó Unir Procesos</button>
                <button class="moderator-btn" onclick="showMessage('Funci√≥n de versiones')">üìã Ver Versiones</button>
            </div>
        </div>

        <div class="content-area">
            <div class="process-header">
                <h1 class="process-title">Proceso de Facturaci√≥n</h1>
                <div class="process-version">üìù Borrador v1.0</div>
            </div>

            <div class="canvas-controls">
                <button class="btn btn-primary" onclick="saveData()">üíæ Guardar</button>
                <button class="btn btn-warning" onclick="startVoting()">üó≥Ô∏è Iniciar Votaci√≥n</button>
                <button class="btn btn-success" onclick="finishSession()">‚úÖ Finalizar</button>
                <button class="btn btn-danger" onclick="clearCanvas()">üóëÔ∏è Limpiar</button>
                <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-primary" onclick="zoomOut()">üîç-</button>
                    <span id="zoomLevel" style="font-weight: bold; min-width: 60px; text-align: center;">100%</span>
                    <button class="btn btn-primary" onclick="zoomIn()">üîç+</button>
                    <button class="btn btn-primary" onclick="resetZoom()">‚Ü∫</button>
                </div>
            </div>

            <div class="canvas" id="canvas">
                <div class="canvas-content" id="canvasContent">
                    <div class="canvas-grid"></div>
                    <div class="flowchart-element start-end" style="top: 100px; left: 100px;" id="start-1">
                        <span>INICIO</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-sidebar">
            <div class="chat-header">üí¨ Chat Colaborativo</div>
            <div class="chat-messages" id="chatMessages">
                <div class="message" style="border-left-color: #e74c3c;">
                    <div class="message-author">Juan P√©rez (Moderador)</div>
                    <div class="message-content">¬°Bienvenidos! Sistema listo para usar.</div>
                    <div class="message-time">10:30 AM</div>
                </div>
                <div class="message" style="border-left-color: #95a5a6;">
                    <div class="message-author">Sistema</div>
                    <div class="message-content">‚úÖ Haz clic en elementos del sidebar para configurarlos</div>
                    <div class="message-time">10:31 AM</div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Escribe un mensaje..." onkeypress="handleChatKeypress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
            </div>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Configurar Elemento</h3>
            </div>
            
            <div class="form-group">
                <label class="form-label">üìù T√≠tulo del Elemento</label>
                <input type="text" id="elementTitle" class="form-control" placeholder="Ej: Validar datos del cliente">
            </div>
            
            <div class="form-group">
                <label class="form-label">üë• Responsable (Selecciona uno)</label>
                <div class="color-selector" id="colorSelector">
                    <div class="color-option" onclick="selectColor('#8B4513', '√Årea Administrativa')">
                        <div class="color-dot" style="background: #8B4513;"></div>
                        <span>√Årea Administrativa</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#3498db', '√Årea T√©cnica')">
                        <div class="color-dot" style="background: #3498db;"></div>
                        <span>√Årea T√©cnica</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#f1c40f', '√Årea Log√≠stica')">
                        <div class="color-dot" style="background: #f1c40f;"></div>
                        <span>√Årea Log√≠stica</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#9b59b6', 'Direcci√≥n')">
                        <div class="color-dot" style="background: #9b59b6;"></div>
                        <span>Direcci√≥n</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#27ae60', 'Cliente')">
                        <div class="color-dot" style="background: #27ae60;"></div>
                        <span>Cliente</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#95a5a6', 'Proveedor')">
                        <div class="color-dot" style="background: #95a5a6;"></div>
                        <span>Proveedor</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#ffffff', 'Cualquier Persona')">
                        <div class="color-dot" style="background: #ffffff; border: 1px solid #ddd;"></div>
                        <span>Cualquier Persona</span>
                    </div>
                    <div class="color-option" onclick="selectColor('#e91e63', 'Externo Caso Especial')">
                        <div class="color-dot" style="background: #e91e63;"></div>
                        <span>Externo Caso Especial</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">üìÑ Descripci√≥n (Opcional)</label>
                <textarea id="elementDescription" class="form-control" rows="3" placeholder="Agrega detalles o instrucciones..."></textarea>
            </div>
            
            <div id="decisionFields" class="form-group" style="display: none;">
                <label class="form-label">üîÄ Opciones de Decisi√≥n</label>
                <div id="decisionOptions">
                    <div class="decision-option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" class="form-control decision-option" placeholder="Ej: S√≠, Aprobado, V√°lido..." style="flex: 1;" value="S√≠">
                        <button type="button" class="btn btn-danger" onclick="removeDecisionOption(this)" style="padding: 0.5rem;">‚ùå</button>
                    </div>
                    <div class="decision-option-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" class="form-control decision-option" placeholder="Ej: No, Rechazado, Inv√°lido..." style="flex: 1;" value="No">
                        <button type="button" class="btn btn-danger" onclick="removeDecisionOption(this)" style="padding: 0.5rem;">‚ùå</button>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="addDecisionOption()" style="width: 100%; margin-top: 0.5rem;">‚ûï Agregar Opci√≥n</button>
            </div>
            
            <div class="modal-footer">
                <button class="btn-modal btn-secondary-modal" onclick="closeModal()">‚ùå Cancelar</button>
                <button class="btn-modal btn-primary-modal" onclick="saveElement()">‚úÖ Guardar</button>
            </div>
        </div>
    </div>

    <div id="connectionModeIndicator" class="connection-mode-indicator">
        üîó MODO CONEXI√ìN: Haz click en dos elementos para conectarlos (ESC para cancelar)
    </div>

    <script>
        console.log('üöÄ Aplicaci√≥n iniciada');
        
        // Variables globales
        let elementCounter = 1;
        let selectedElementColor = '#f1c40f';
        let selectedEntityName = '√Årea Log√≠stica';
        let currentElementType = '';
        let editingElementId = null;
        let connectionMode = false;
        let selectedForConnection = null;
        let connections = [];
        let zoomLevel = 1;

        // FUNCIONES B√ÅSICAS
        function showTab(tabName) {
            console.log('üì± Cambiando a tab:', tabName);
            
            const panels = document.querySelectorAll('.tab-panel');
            panels.forEach(panel => panel.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            addChatMessage(`üì± Cambiado a: ${getTabName(tabName)}`, 'Sistema');
        }

        function getTabName(tabName) {
            const names = {
                'shapes': 'Formas',
                'concepts': 'Conceptos', 
                'participants': 'Participantes'
            };
            return names[tabName] || tabName;
        }

        function openConfigModal(elementType) {
            console.log('‚öôÔ∏è Abriendo modal para:', elementType);
            currentElementType = elementType;
            editingElementId = null;
            
            const modal = document.getElementById('configModal');
            const modalTitle = document.getElementById('modalTitle');
            const decisionFields = document.getElementById('decisionFields');
            
            modalTitle.textContent = `Configurar ${getElementName(elementType)}`;
            
            document.getElementById('elementTitle').value = getDefaultTitle(elementType);
            document.getElementById('elementDescription').value = '';
            
            if (elementType === 'decision') {
                decisionFields.style.display = 'block';
                setDecisionOptions(['S√≠', 'No']);
            } else {
                decisionFields.style.display = 'none';
            }
            
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => option.classList.remove('selected'));
            
            selectedElementColor = '#f1c40f';
            selectedEntityName = '√Årea Log√≠stica';
            const defaultOption = document.querySelector('.color-option:nth-child(3)');
            if (defaultOption) {
                defaultOption.classList.add('selected');
            }
            
            modal.classList.add('show');
            addChatMessage(`‚öôÔ∏è Configurando ${getElementName(elementType)}`, 'Sistema');
        }

        function editElement(elementId) {
            console.log('‚úèÔ∏è Editando elemento:', elementId);
            editingElementId = elementId;
            
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const title = element.querySelector('span').textContent.split('\n')[0];
            const modal = document.getElementById('configModal');
            const modalTitle = document.getElementById('modalTitle');
            const decisionFields = document.getElementById('decisionFields');
            
            modalTitle.textContent = `Editar Elemento`;
            
            document.getElementById('elementTitle').value = title;
            document.getElementById('elementDescription').value = element.dataset.description || '';
            
            const elementType = element.className.split(' ')[1];
            
            if (elementType === 'decision') {
                decisionFields.style.display = 'block';
                const existingOptions = element.dataset.decisionOptions ? 
                    JSON.parse(element.dataset.decisionOptions) : ['S√≠', 'No'];
                setDecisionOptions(existingOptions);
            } else {
                decisionFields.style.display = 'none';
            }
            
            modal.classList.add('show');
            addChatMessage(`‚úèÔ∏è Editando: ${title}`, 'Sistema');
        }

        function selectColor(color, entityName) {
            selectedElementColor = color;
            selectedEntityName = entityName;
            
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => option.classList.remove('selected'));
            
            if (event) {
                const clickedOption = event.target.closest('.color-option');
                if (clickedOption) {
                    clickedOption.classList.add('selected');
                }
            }
            
            addChatMessage(`üé® Responsable: ${entityName}`, 'Sistema');
        }

        function saveElement() {
            const title = document.getElementById('elementTitle').value.trim();
            const description = document.getElementById('elementDescription').value.trim();
            
            if (!title) {
                alert('‚ùå Por favor ingresa un t√≠tulo');
                return;
            }
            
            if (editingElementId) {
                updateElement(editingElementId, title, description);
            } else {
                createElement(currentElementType, title, description);
            }
            
            closeModal();
        }

        function createElement(elementType, title, description) {
            elementCounter++;
            const canvasContent = document.getElementById('canvasContent');
            const element = document.createElement('div');
            const elementId = `${elementType}-${elementCounter}`;
            
            element.className = `flowchart-element ${elementType}`;
            element.id = elementId;
            element.style.position = 'absolute';
            element.style.left = `${50 + Math.random() * 300}px`;
            element.style.top = `${50 + Math.random() * 200}px`;
            element.style.borderColor = selectedElementColor;
            element.dataset.description = description;
            
            if (elementType === 'decision') {
                const options = getDecisionOptions();
                element.dataset.decisionOptions = JSON.stringify(options);
                
                element.innerHTML = `<span>${title}</span>`;
                element.title = `Opciones: ${options.join(', ')}`;
                
                // Crear puntos de conexi√≥n para cada opci√≥n
                createDecisionConnectionPoints(element, options);
            } else {
                element.innerHTML = `<span>${title}</span>`;
            }
            
            applyElementStyles(element, selectedElementColor);
            makeElementDraggable(element);
            element.ondblclick = () => editElement(elementId);
            
            canvasContent.appendChild(element);
            addChatMessage(`‚úÖ "${title}" creado (${selectedEntityName})`, 'Sistema');
            
            if (elementType === 'decision') {
                const options = getDecisionOptions();
                addChatMessage(`üîÄ Opciones: ${options.join(', ')}`, 'Sistema');
            }
        }

        function createDecisionConnectionPoints(element, options) {
            const positions = ['top', 'right', 'bottom', 'left'];
            
            options.forEach((option, index) => {
                if (index < 4) { // M√°ximo 4 opciones
                    const point = document.createElement('div');
                    point.className = `decision-connection-point ${positions[index]}`;
                    point.dataset.option = option;
                    point.dataset.optionIndex = index;
                    point.title = option;
                    
                    // Mostrar las primeras 1-2 letras de la opci√≥n
                    point.textContent = option.substring(0, 2).toUpperCase();
                    
                    // Evento para conexiones espec√≠ficas
                    point.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (connectionMode) {
                            handleDecisionPointClick(element, point, option);
                        }
                    });
                    
                    element.appendChild(point);
                }
            });
        }

        function updateElement(elementId, title, description) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const elementType = element.className.split(' ')[1];
            
            if (elementType === 'decision') {
                const options = getDecisionOptions();
                element.dataset.decisionOptions = JSON.stringify(options);
                
                // Limpiar puntos de conexi√≥n existentes
                const existingPoints = element.querySelectorAll('.decision-connection-point');
                existingPoints.forEach(point => point.remove());
                
                element.querySelector('span').textContent = title;
                element.title = `Opciones: ${options.join(', ')}`;
                
                // Recrear puntos de conexi√≥n
                createDecisionConnectionPoints(element, options);
                
                addChatMessage(`üîÄ Opciones actualizadas: ${options.join(', ')}`, 'Sistema');
            } else {
                element.querySelector('span').textContent = title;
            }
            
            element.style.borderColor = selectedElementColor;
            element.dataset.description = description;
            applyElementStyles(element, selectedElementColor);
            addChatMessage(`‚úèÔ∏è "${title}" actualizado`, 'Sistema');
        }

        function applyElementStyles(element, color) {
            const lightColors = {
                '#8B4513': '#f4e4bc',   // Caf√© claro para √Årea Administrativa
                '#3498db': '#e3f2fd',   // Azul claro para √Årea T√©cnica
                '#f1c40f': '#fef9e7',   // Amarillo claro para √Årea Log√≠stica
                '#9b59b6': '#f3e5f5',   // Lila claro para Direcci√≥n
                '#27ae60': '#e8f5e8',   // Verde claro para Cliente
                '#95a5a6': '#f8f9fa',   // Gris claro para Proveedor
                '#ffffff': '#ffffff',   // Blanco para Cualquier Persona
                '#e91e63': '#fce4ec'    // Rosa claro para Externo Caso Especial
            };
            
            if (lightColors[color]) {
                element.style.backgroundColor = lightColors[color];
            }
            
            // Manejo especial para el color blanco (necesita borde m√°s visible)
            if (color === '#ffffff') {
                element.style.border = '3px solid #95a5a6';
            }
        }

        function closeModal() {
            document.getElementById('configModal').classList.remove('show');
            currentElementType = '';
            editingElementId = null;
        }

        function getElementName(elementType) {
            const names = {
                'start-end': 'Inicio/Fin',
                'process': 'Proceso', 
                'decision': 'Decisi√≥n',
                'document': 'Documento',
                'data': 'Datos'
            };
            return names[elementType] || elementType;
        }

        function getDefaultTitle(elementType) {
            const titles = {
                'start-end': 'INICIO/FIN',
                'process': 'NUEVO PROCESO',
                'decision': '¬øDECISI√ìN?',
                'document': 'DOCUMENTO',
                'data': 'DATOS'
            };
            return titles[elementType] || 'ELEMENTO';
        }

        // FUNCIONES DE DECISI√ìN
        function addDecisionOption() {
            const container = document.getElementById('decisionOptions');
            const newRow = document.createElement('div');
            newRow.className = 'decision-option-row';
            newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            
            newRow.innerHTML = `
                <input type="text" class="form-control decision-option" placeholder="Nueva opci√≥n..." style="flex: 1;">
                <button type="button" class="btn btn-danger" onclick="removeDecisionOption(this)" style="padding: 0.5rem;">‚ùå</button>
            `;
            
            container.appendChild(newRow);
        }

        function removeDecisionOption(button) {
            const row = button.parentElement;
            const container = document.getElementById('decisionOptions');
            
            if (container.children.length > 2) {
                row.remove();
            } else {
                alert('Una decisi√≥n debe tener al menos 2 opciones');
            }
        }

        function getDecisionOptions() {
            const inputs = document.querySelectorAll('.decision-option');
            const options = [];
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    options.push(value);
                }
            });
            
            return options;
        }

        function setDecisionOptions(options) {
            const container = document.getElementById('decisionOptions');
            container.innerHTML = '';
            
            if (options.length < 2) {
                options = ['S√≠', 'No'];
            }
            
            options.forEach(option => {
                const row = document.createElement('div');
                row.className = 'decision-option-row';
                row.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                
                row.innerHTML = `
                    <input type="text" class="form-control decision-option" value="${option}" style="flex: 1;">
                    <button type="button" class="btn btn-danger" onclick="removeDecisionOption(this)" style="padding: 0.5rem;">‚ùå</button>
                `;
                
                container.appendChild(row);
            });
        }

        // FUNCIONES DE POST-ITS
        function createPostIt() {
            const canvasContent = document.getElementById('canvasContent');
            const postIt = document.createElement('div');
            const postItId = `postit-${Date.now()}`;
            
            postIt.className = 'post-it';
            postIt.id = postItId;
            postIt.style.left = `${100 + Math.random() * 200}px`;
            postIt.style.top = `${100 + Math.random() * 200}px`;
            
            const colors = ['', 'blue', 'green', 'pink'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            if (randomColor) postIt.classList.add(randomColor);
            
            postIt.innerHTML = `
                <div class="post-it-controls">
                    <button class="post-it-btn post-it-delete" onclick="deletePostIt('${postItId}')" title="Eliminar">√ó</button>
                </div>
                <textarea class="post-it-content" placeholder="Escribe tu nota aqu√≠..." onkeyup="savePostItContent('${postItId}', this.value)"></textarea>
            `;
            
            makePostItDraggable(postIt);
            canvasContent.appendChild(postIt);
            
            // Enfocar el textarea
            setTimeout(() => {
                const textarea = postIt.querySelector('.post-it-content');
                textarea.focus();
            }, 100);
            
            addChatMessage('üìù Post-it creado', 'Sistema');
        }

        function deletePostIt(postItId) {
            const postIt = document.getElementById(postItId);
            if (postIt && confirm('¬øEliminar esta nota?')) {
                postIt.remove();
                addChatMessage('üóëÔ∏è Post-it eliminado', 'Sistema');
            }
        }

        function savePostItContent(postItId, content) {
            const postIt = document.getElementById(postItId);
            if (postIt) {
                postIt.dataset.content = content;
            }
        }

        function makePostItDraggable(postIt) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            postIt.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON') return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const style = window.getComputedStyle(postIt);
                startLeft = parseInt(style.left) || 0;
                startTop = parseInt(style.top) || 0;
                
                postIt.style.zIndex = 1000;
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                postIt.style.left = `${startLeft + dx}px`;
                postIt.style.top = `${startTop + dy}px`;
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    postIt.style.zIndex = 50;
                }
            });
        }

        // MANEJO DE CONEXIONES ESPEC√çFICAS PARA DECISIONES
        function handleDecisionPointClick(decisionElement, point, option) {
            if (!selectedForConnection) {
                // Primer click - seleccionar punto de decisi√≥n
                selectedForConnection = { element: decisionElement, point: point, option: option };
                point.style.background = '#27ae60';
                addChatMessage(`üéØ Origen seleccionado: ${option}`, 'Sistema');
            } else if (selectedForConnection.element === decisionElement && selectedForConnection.point === point) {
                // Deseleccionar el mismo punto
                point.style.background = '#f39c12';
                selectedForConnection = null;
                addChatMessage('‚ùå Selecci√≥n cancelada', 'Sistema');
            } else {
                // Error - no se puede conectar decisi√≥n a decisi√≥n directamente
                addChatMessage('‚ùå Selecciona un elemento de destino, no otro punto de decisi√≥n', 'Sistema');
            }
        }

        // Actualizar handleElementClickForConnection para manejar conexiones desde puntos de decisi√≥n
        function handleElementClickForConnection(element) {
            if (!connectionMode) return false;
            
            if (!selectedForConnection) {
                // Seleccionar elemento normal
                selectedForConnection = { element: element };
                element.classList.add('selected-for-connection');
                addChatMessage(`üéØ Elemento origen: ${element.querySelector('span').textContent}`, 'Sistema');
                return true;
            } else if (selectedForConnection.element === element && !selectedForConnection.point) {
                // Deseleccionar elemento normal
                selectedForConnection.element.classList.remove('selected-for-connection');
                selectedForConnection = null;
                addChatMessage('‚ùå Selecci√≥n cancelada', 'Sistema');
                return true;
            } else {
                // Crear conexi√≥n
                if (selectedForConnection.point) {
                    // Conexi√≥n desde punto de decisi√≥n
                    createDecisionConnection(selectedForConnection, element);
                } else {
                    // Conexi√≥n normal
                    createConnection(selectedForConnection.element, element);
                }
                
                // Limpiar selecci√≥n
                if (selectedForConnection.element.classList) {
                    selectedForConnection.element.classList.remove('selected-for-connection');
                }
                if (selectedForConnection.point) {
                    selectedForConnection.point.style.background = '#f39c12';
                }
                selectedForConnection = null;
                toggleConnectionMode();
                return true;
            }
        }

        function createDecisionConnection(fromSelection, toElement) {
            console.log('üîó Creando conexi√≥n de decisi√≥n:', fromSelection.option, '‚Üí', toElement.id);
            
            const connectionId = `conn_${Date.now()}`;
            const connection = {
                id: connectionId,
                from: fromSelection.element.id,
                fromPoint: fromSelection.point,
                fromOption: fromSelection.option,
                to: toElement.id,
                segments: [],
                arrow: null,
                wrapper: null,
                label: null
            };
            
            // Crear contenedor para la conexi√≥n
            const wrapper = document.createElement('div');
            wrapper.className = 'connection-wrapper';
            wrapper.id = connectionId + '_wrapper';
            wrapper.style.position = 'absolute';
            wrapper.style.top = '0';
            wrapper.style.left = '0';
            wrapper.style.width = '100%';
            wrapper.style.height = '100%';
            wrapper.style.pointerEvents = 'none';
            wrapper.style.zIndex = '10';
            
            const canvasContent = document.getElementById('canvasContent');
            canvasContent.appendChild(wrapper);
            
            // Crear flecha
            const arrow = document.createElement('div');
            arrow.className = 'connection-arrow';
            arrow.id = connectionId + '_arrow';
            wrapper.appendChild(arrow);
            
            // Crear etiqueta con las primeras dos letras
            const label = document.createElement('div');
            label.className = 'connection-label';
            label.textContent = fromSelection.option.substring(0, 2).toUpperCase();
            label.title = fromSelection.option; // Tooltip completo
            wrapper.appendChild(label);
            
            connection.arrow = arrow;
            connection.wrapper = wrapper;
            connection.label = label;
            connections.push(connection);
            
            console.log('üìä Conexi√≥n de decisi√≥n creada, actualizando posici√≥n...');
            updateDecisionConnection(connection);
            
            addChatMessage(`‚úÖ Conexi√≥n creada: ${fromSelection.option} ‚Üí ${toElement.querySelector('span').textContent}`, 'Sistema');
        }

        function updateDecisionConnection(connection) {
            const fromElement = document.getElementById(connection.from);
            const toElement = document.getElementById(connection.to);
            
            if (!fromElement || !toElement || !connection.wrapper) return;
            
            console.log('üîÑ Actualizando conexi√≥n de decisi√≥n:', connection.id);
            
            // Limpiar segmentos anteriores
            connection.segments.forEach(segment => {
                if (segment.parentNode) {
                    segment.parentNode.removeChild(segment);
                }
            });
            connection.segments = [];
            
            // Obtener posici√≥n del punto de decisi√≥n
            const fromPoint = getDecisionPointPosition(fromElement, connection.fromPoint);
            
            // Obtener punto de borde del elemento destino
            const toRect = toElement.getBoundingClientRect();
            const canvasRect = fromElement.parentElement.getBoundingClientRect();
            
            const toEdge = getEdgePoint(toRect, fromPoint, canvasRect);
            
            console.log('üìç Puntos de conexi√≥n:', fromPoint, '‚Üí', toEdge);
            
            // Crear l√≠nea simple
            const line = document.createElement('div');
            line.style.position = 'absolute';
            line.style.background = '#3498db';
            line.style.height = '3px';
            line.style.zIndex = '10';
            line.style.pointerEvents = 'none';
            
            const dx = toEdge.x - fromPoint.x;
            const dy = toEdge.y - fromPoint.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            line.style.left = fromPoint.x + 'px';
            line.style.top = fromPoint.y + 'px';
            line.style.width = length + 'px';
            line.style.transformOrigin = 'left center';
            line.style.transform = `rotate(${angle}deg)`;
            
            connection.wrapper.appendChild(line);
            connection.segments.push(line);
            
            // Posicionar flecha
            connection.arrow.style.left = (toEdge.x - 4) + 'px';
            connection.arrow.style.top = (toEdge.y - 3) + 'px';
            connection.arrow.style.transform = `rotate(${angle}deg)`;
            
            // Posicionar etiqueta en el medio de la l√≠nea
            const midX = fromPoint.x + dx * 0.5;
            const midY = fromPoint.y + dy * 0.5;
            connection.label.style.left = midX + 'px';
            connection.label.style.top = (midY - 10) + 'px';
            
            console.log('‚úÖ Conexi√≥n de decisi√≥n actualizada');
        }

        function getDecisionPointPosition(decisionElement, point) {
            const canvasContent = document.getElementById('canvasContent');
            const canvasRect = canvasContent.getBoundingClientRect();
            const pointRect = point.getBoundingClientRect();
            
            const x = pointRect.left - canvasRect.left + pointRect.width / 2;
            const y = pointRect.top - canvasRect.top + pointRect.height / 2;
            
            console.log('üìç Posici√≥n del punto de decisi√≥n:', { x, y });
            return { x, y };
        }
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.2, 3);
            applyZoom();
            addChatMessage(`üîç+ Zoom: ${Math.round(zoomLevel * 100)}%`, 'Sistema');
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.2, 0.3);
            applyZoom();
            addChatMessage(`üîç- Zoom: ${Math.round(zoomLevel * 100)}%`, 'Sistema');
        }

        function resetZoom() {
            zoomLevel = 1;
            applyZoom();
            addChatMessage(`‚Ü∫ Zoom restablecido: 100%`, 'Sistema');
        }

        function applyZoom() {
            const canvasContent = document.getElementById('canvasContent');
            const zoomDisplay = document.getElementById('zoomLevel');
            
            canvasContent.style.transform = `scale(${zoomLevel})`;
            zoomDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
            
            setTimeout(() => {
                updateAllConnections();
            }, 100);
        }

        // SISTEMA DE CONEXIONES
        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            const canvas = document.getElementById('canvas');
            const indicator = document.getElementById('connectionModeIndicator');
            
            if (connectionMode) {
                canvas.classList.add('connection-mode');
                indicator.classList.add('show');
                selectedForConnection = null;
                addChatMessage('üîó Modo conexi√≥n activado', 'Sistema');
            } else {
                canvas.classList.remove('connection-mode');
                indicator.classList.remove('show');
                if (selectedForConnection) {
                    selectedForConnection.classList.remove('selected-for-connection');
                    selectedForConnection = null;
                }
                addChatMessage('‚ùå Modo conexi√≥n desactivado', 'Sistema');
            }
        }

        function handleElementClickForConnection(element) {
            if (!connectionMode) return false;
            
            if (!selectedForConnection) {
                selectedForConnection = element;
                element.classList.add('selected-for-connection');
                addChatMessage(`üéØ Elemento origen: ${element.querySelector('span').textContent}`, 'Sistema');
                return true;
            } else if (selectedForConnection === element) {
                selectedForConnection.classList.remove('selected-for-connection');
                selectedForConnection = null;
                addChatMessage('‚ùå Selecci√≥n cancelada', 'Sistema');
                return true;
            } else {
                createConnection(selectedForConnection, element);
                selectedForConnection.classList.remove('selected-for-connection');
                selectedForConnection = null;
                toggleConnectionMode();
                return true;
            }
        }

        function createConnection(fromElement, toElement) {
            console.log('üîó Creando conexi√≥n entre:', fromElement.id, 'y', toElement.id);
            
            const connectionId = `conn_${Date.now()}`;
            const connection = {
                id: connectionId,
                from: fromElement.id,
                to: toElement.id,
                segments: [],
                arrow: null,
                wrapper: null
            };
            
            // Crear contenedor para la conexi√≥n
            const wrapper = document.createElement('div');
            wrapper.className = 'connection-wrapper';
            wrapper.id = connectionId + '_wrapper';
            wrapper.style.position = 'absolute';
            wrapper.style.top = '0';
            wrapper.style.left = '0';
            wrapper.style.width = '100%';
            wrapper.style.height = '100%';
            wrapper.style.pointerEvents = 'none';
            wrapper.style.zIndex = '10';
            
            const canvasContent = document.getElementById('canvasContent');
            canvasContent.appendChild(wrapper);
            
            // Crear flecha
            const arrow = document.createElement('div');
            arrow.className = 'connection-arrow';
            arrow.id = connectionId + '_arrow';
            wrapper.appendChild(arrow);
            
            connection.arrow = arrow;
            connection.wrapper = wrapper;
            connections.push(connection);
            
            console.log('üìä Conexi√≥n creada, actualizando posici√≥n...');
            updateConnectionWithCurves(connection);
            
            addChatMessage(`‚úÖ Conexi√≥n creada: ${fromElement.querySelector('span').textContent} ‚Üí ${toElement.querySelector('span').textContent}`, 'Sistema');
        }

        function updateConnectionWithCurves(connection) {
            const fromElement = document.getElementById(connection.from);
            const toElement = document.getElementById(connection.to);
            
            if (!fromElement || !toElement || !connection.wrapper) return;
            
            // Limpiar segmentos anteriores
            connection.segments.forEach(segment => {
                if (segment.parentNode) {
                    segment.parentNode.removeChild(segment);
                }
            });
            connection.segments = [];
            
            // Calcular puntos de conexi√≥n en los bordes
            const fromRect = fromElement.getBoundingClientRect();
            const toRect = toElement.getBoundingClientRect();
            const canvasRect = fromElement.parentElement.getBoundingClientRect();
            
            // Convertir a coordenadas relativas al canvas
            const fromCenter = {
                x: fromRect.left - canvasRect.left + fromRect.width / 2,
                y: fromRect.top - canvasRect.top + fromRect.height / 2
            };
            
            const toCenter = {
                x: toRect.left - canvasRect.left + toRect.width / 2,
                y: toRect.top - canvasRect.top + toRect.height / 2
            };
            
            // Calcular puntos de conexi√≥n en los bordes
            const fromEdge = getEdgePoint(fromRect, toCenter, canvasRect);
            const toEdge = getEdgePoint(toRect, fromCenter, canvasRect);
            
            // Crear conexi√≥n con codos (en forma de L o Z)
            createSegmentedConnection(connection, fromEdge, toEdge);
        }

        function getEdgePoint(elementRect, targetPoint, canvasRect) {
            const relativeRect = {
                left: elementRect.left - canvasRect.left,
                top: elementRect.top - canvasRect.top,
                width: elementRect.width,
                height: elementRect.height
            };
            
            const centerX = relativeRect.left + relativeRect.width / 2;
            const centerY = relativeRect.top + relativeRect.height / 2;
            
            const dx = targetPoint.x - centerX;
            const dy = targetPoint.y - centerY;
            
            // Calcular la intersecci√≥n con el borde del rect√°ngulo
            const halfWidth = relativeRect.width / 2;
            const halfHeight = relativeRect.height / 2;
            
            let edgeX, edgeY;
            
            // Determinar qu√© borde es el m√°s cercano
            const ratioX = Math.abs(dx / halfWidth);
            const ratioY = Math.abs(dy / halfHeight);
            
            if (ratioX > ratioY) {
                // Intersecci√≥n con borde izquierdo o derecho
                edgeX = centerX + (dx > 0 ? halfWidth : -halfWidth);
                edgeY = centerY + (dy * halfWidth / Math.abs(dx));
                
                // Asegurar que Y est√© dentro de los l√≠mites
                edgeY = Math.max(relativeRect.top, Math.min(relativeRect.top + relativeRect.height, edgeY));
            } else {
                // Intersecci√≥n con borde superior o inferior
                edgeY = centerY + (dy > 0 ? halfHeight : -halfHeight);
                edgeX = centerX + (dx * halfHeight / Math.abs(dy));
                
                // Asegurar que X est√© dentro de los l√≠mites
                edgeX = Math.max(relativeRect.left, Math.min(relativeRect.left + relativeRect.width, edgeX));
            }
            
            return { x: edgeX, y: edgeY };
        }

        function createSegmentedConnection(connection, fromPoint, toPoint) {
            const wrapper = connection.wrapper;
            console.log('üìè Creando segmentos desde', fromPoint, 'hasta', toPoint);
            
            // Limpiar segmentos anteriores
            connection.segments.forEach(segment => {
                if (segment.parentNode) {
                    segment.parentNode.removeChild(segment);
                }
            });
            connection.segments = [];
            
            // Crear una l√≠nea simple por ahora para debugging
            const line = document.createElement('div');
            line.style.position = 'absolute';
            line.style.background = '#3498db';
            line.style.height = '3px';
            line.style.zIndex = '10';
            line.style.pointerEvents = 'none';
            
            // Calcular distancia y √°ngulo
            const dx = toPoint.x - fromPoint.x;
            const dy = toPoint.y - fromPoint.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // Posicionar l√≠nea
            line.style.left = fromPoint.x + 'px';
            line.style.top = fromPoint.y + 'px';
            line.style.width = length + 'px';
            line.style.transformOrigin = 'left center';
            line.style.transform = `rotate(${angle}deg)`;
            
            wrapper.appendChild(line);
            connection.segments.push(line);
            
            // Posicionar flecha
            connection.arrow.style.left = (toPoint.x - 4) + 'px';
            connection.arrow.style.top = (toPoint.y - 3) + 'px';
            connection.arrow.style.transform = `rotate(${angle}deg)`;
            
            console.log('‚úÖ L√≠nea creada con longitud:', length, 'y √°ngulo:', angle);
        }

        function updateConnectionPosition(connection) {
            // Esta funci√≥n ahora llama a la nueva funci√≥n con codos
            updateConnectionWithCurves(connection);
        }

        function updateAllConnections() {
            connections.forEach(connection => {
                if (connection.fromPoint) {
                    // Conexi√≥n desde punto de decisi√≥n
                    updateDecisionConnection(connection);
                } else {
                    // Conexi√≥n normal
                    updateConnectionWithCurves(connection);
                }
            });
        }

        // DRAG AND DROP
        function makeElementDraggable(element) {
            let isDragging = false;
            let hasDragged = false;
            let startX, startY, startLeft, startTop;
            let mouseDownTime = 0;

            function getElementPosition(el) {
                const style = window.getComputedStyle(el);
                return {
                    left: parseInt(style.left) || 0,
                    top: parseInt(style.top) || 0
                };
            }

            element.addEventListener('mousedown', function(e) {
                mouseDownTime = Date.now();
                isDragging = false;
                hasDragged = false;
                
                startX = e.clientX;
                startY = e.clientY;
                
                const pos = getElementPosition(element);
                startLeft = pos.left;
                startTop = pos.top;
                
                element.style.zIndex = 1000;
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('mousemove', function(e) {
                if (mouseDownTime === 0) return;
                
                const deltaX = Math.abs(e.clientX - startX);
                const deltaY = Math.abs(e.clientY - startY);
                const timeDiff = Date.now() - mouseDownTime;
                
                if ((deltaX > 5 || deltaY > 5) && timeDiff > 50) {
                    if (!isDragging) {
                        isDragging = true;
                        hasDragged = true;
                        element.style.cursor = 'grabbing';
                        addChatMessage(`üñ±Ô∏è Arrastrando: ${element.querySelector('span').textContent}`, 'Sistema');
                    }
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    const newLeft = Math.max(0, startLeft + dx);
                    const newTop = Math.max(0, startTop + dy);
                    
                    element.style.left = `${newLeft}px`;
                    element.style.top = `${newTop}px`;
                    
                    updateAllConnections();
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (mouseDownTime === 0) return;
                
                const timeDiff = Date.now() - mouseDownTime;
                
                if (isDragging) {
                    addChatMessage(`‚úÖ Elemento reposicionado`, 'Sistema');
                    updateAllConnections();
                } else if (!hasDragged && timeDiff < 500) {
                    if (handleElementClickForConnection(element)) {
                        console.log('üëÜ Click manejado por modo conexi√≥n');
                    } else {
                        addChatMessage(`üëÜ Click en: ${element.querySelector('span').textContent}`, 'Sistema');
                    }
                }
                
                isDragging = false;
                hasDragged = false;
                mouseDownTime = 0;
                element.style.zIndex = 'auto';
                element.style.cursor = 'move';
                
                e.stopPropagation();
            });

            element.addEventListener('dblclick', function(e) {
                editElement(element.id);
                e.preventDefault();
                e.stopPropagation();
            });

            element.style.cursor = 'move';
        }

        // FUNCIONES DE CHAT
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage(message, 'Juan P√©rez', 'Moderador');
                input.value = '';
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addChatMessage(message, author = 'Sistema', role = '') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const userColors = {
                'Juan P√©rez': '#8B4513',        // √Årea Administrativa
                'Mar√≠a Garc√≠a': '#3498db',      // √Årea T√©cnica 
                'Carlos L√≥pez': '#f1c40f',      // √Årea Log√≠stica
                'Ana Mart√≠nez': '#9b59b6',      // Direcci√≥n
                'Cliente': '#27ae60',           // Cliente
                'Sistema': '#95a5a6'            // Sistema (Proveedor/Gris)
            };
            
            messageDiv.style.borderLeftColor = userColors[author] || '#95a5a6';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-author">${author}${role ? ` (${role})` : ''}</div>
                <div class="message-content">${message}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // FUNCIONES DE BOTONES
        function saveData() {
            addChatMessage('üíæ Datos guardados exitosamente', 'Sistema');
        }

        function startVoting() {
            addChatMessage('üó≥Ô∏è Votaci√≥n iniciada por el moderador', 'Sistema');
        }

        function finishSession() {
            addChatMessage('üîö Sesi√≥n finalizada por el moderador', 'Sistema');
        }

        function clearCanvas() {
            if (confirm('¬øLimpiar todos los elementos?')) {
                const elements = document.querySelectorAll('.flowchart-element');
                elements.forEach(el => {
                    if (el.id !== 'start-1') el.remove();
                });
                connections = [];
                const connectionElements = document.querySelectorAll('.connection-line, .connection-arrow, .connection-segment, .connection-wrapper');
                connectionElements.forEach(el => el.remove());
                addChatMessage('üóëÔ∏è Canvas limpiado', 'Sistema');
            }
        }

        function openConceptModal(conceptId) {
            addChatMessage(`üìö Abriendo concepto: ${conceptId}`, 'Sistema');
        }

        function showMessage(message) {
            addChatMessage(`‚ÑπÔ∏è ${message}`, 'Sistema');
        }

        // RESIZE FUNCTIONALITY
        let isResizing = false;
        let startY = 0;
        let startHeight = 0;

        document.getElementById('resizeHandle').addEventListener('mousedown', function(e) {
            isResizing = true;
            startY = e.clientY;
            startHeight = document.getElementById('moderatorPanel').offsetHeight;
            addChatMessage('üéØ Redimensionando panel...', 'Sistema');
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (isResizing) {
                const deltaY = startY - e.clientY;
                const newHeight = Math.max(100, Math.min(500, startHeight + deltaY));
                document.getElementById('moderatorPanel').style.height = newHeight + 'px';
            }
        });

        document.addEventListener('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                addChatMessage('‚úÖ Panel redimensionado', 'Sistema');
            }
        });

        // INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando aplicaci√≥n...');
            
            const startElement = document.getElementById('start-1');
            if (startElement) {
                makeElementDraggable(startElement);
                startElement.dataset.description = 'Punto de inicio del proceso';
            }
            
            document.getElementById('configModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && connectionMode) {
                    toggleConnectionMode();
                }
            });
            
            applyZoom();
            
            addChatMessage('‚úÖ Sistema listo - Haz clic en elementos para configurarlos', 'Sistema');
            addChatMessage('üí° Doble clic en elementos para editarlos', 'Sistema');
            addChatMessage('üñ±Ô∏è Arrastra elementos para moverlos', 'Sistema');
            addChatMessage('üîó Usa "Conectar" para unir elementos con flechas', 'Sistema');
            addChatMessage('üîç Usa los controles de zoom para navegar mejor', 'Sistema');
        });

        console.log('‚úÖ JavaScript cargado correctamente');
    </script>
</body>
</html>